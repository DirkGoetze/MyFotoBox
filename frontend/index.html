<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Fotobox</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        #photos img { max-width: 200px; margin: 0.5em; }
        #menu { margin-bottom: 1em; }
        #galleryView { display: none; }
        #galleryPhotos img { max-width: 300px; margin: 0.5em; border-radius: 8px; box-shadow: 0 2px 8px #888; }
        #backBtn { margin-top: 1em; }
    </style>
</head>
<body>
    <div id="menu">
        <button id="showCapture">Aufnahme</button>
        <button id="showGallery">Galerie</button>
    </div>
    <div id="captureView">
        <h1>Fotobox</h1>
        <div id="eventName"></div>
        <button id="takePhotoBtn">Foto aufnehmen</button>
        <h2>Aufgenommene Fotos</h2>
        <div id="photos"></div>
    </div>
    <div id="galleryView">
        <h1>Galerie</h1>
        <div id="galleryPhotos"></div>
        <button id="backBtn">Zurück zur Aufnahme</button>
    </div>
    <a href="start.html" style="position:fixed;top:1em;right:1em;">Zurück zur Startseite</a>
    <script>
        let galleryTimeout = null;
        let galleryTimeoutMs = 60000; // Default 60s, wird aus Settings geladen
        let lastInteraction = Date.now();

        function resetGalleryTimeout() {
            lastInteraction = Date.now();
            if (galleryTimeout) clearTimeout(galleryTimeout);
            galleryTimeout = setTimeout(() => {
                if (document.getElementById('galleryView').style.display !== 'none') {
                    showCaptureView();
                }
            }, galleryTimeoutMs);
        }

        function showGalleryView() {
            document.getElementById('captureView').style.display = 'none';
            document.getElementById('galleryView').style.display = '';
            loadGalleryPhotos();
            resetGalleryTimeout();
            document.onmousemove = document.onkeydown = resetGalleryTimeout;
        }
        function showCaptureView() {
            document.getElementById('galleryView').style.display = 'none';
            document.getElementById('captureView').style.display = '';
            document.onmousemove = document.onkeydown = null;
        }
        document.getElementById('showGallery').onclick = showGalleryView;
        document.getElementById('showCapture').onclick = showCaptureView;
        document.getElementById('backBtn').onclick = showCaptureView;

        // Eventname aus Konfiguration anzeigen (per API)
        fetch('/api/settings').then(r=>r.json()).then(config => {
            if(config.event_name) {
                document.getElementById('eventName').textContent = config.event_name;
            }
            if(config.gallery_timeout_ms) {
                galleryTimeoutMs = parseInt(config.gallery_timeout_ms)||60000;
            }
        });
        async function loadPhotos() {
            const res = await fetch('/api/photos');
            const data = await res.json();
            const photosDiv = document.getElementById('photos');
            photosDiv.innerHTML = '';
            data.photos.forEach(photo => {
                const img = document.createElement('img');
                img.src = '/photos/' + photo;
                photosDiv.appendChild(img);
            });
        }
        async function loadGalleryPhotos() {
            const res = await fetch('/api/gallery');
            const data = await res.json();
            const galleryDiv = document.getElementById('galleryPhotos');
            galleryDiv.innerHTML = '';
            data.photos.forEach(photo => {
                const img = document.createElement('img');
                img.src = '/photos/gallery/' + photo;
                galleryDiv.appendChild(img);
            });
        }
        document.getElementById('takePhotoBtn').onclick = async () => {
            await fetch('/api/take_photo', { method: 'POST' });
            loadPhotos();
        };
        loadPhotos();
        showCaptureView();
    </script>
</body>
</html>
